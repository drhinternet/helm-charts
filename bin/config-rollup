#!/usr/bin/env ruby

require 'yaml'
require 'optparse'

def main
  # Parse options.

  input_file           = "values.yaml"
  output_file          = "values.yaml"
  config_all           = "config.all"
  config_mta           = "config.mta"
  config_event_tracker = "config.event-tracker"
  config_tls           = "config.tls"

  OptionParser.new do |opts|
    opts.on("--input=values.yaml", "The values.yaml file to use as input. (Default: values.yaml)") do |opt|
      if ( val = opt.to_s ) == ""
        die("--input= cannot be blank")
      end
      input_file = val
    end
    opts.on("--output=values.yaml", "The values.yaml file to use as output. This may be the same as the input values file. (Default: values.yaml)") do |opt|
      if ( val = opt.to_s ) == ""
        die("--output= cannot be blank")
      end
      output_file = val
    end
  end.parse!

  if !File.readable?(input_file)
    die("file #{ input_file } cannot be read")
  end

  [ config_all, config_mta, config_event_tracker, config_tls ].each do |dir|
    if !File.directory?(dir)
      die("#{ dir } is not a directory")
    end
  end

  # Read values.yaml

  input_yaml   = File.read(input_file, encoding: "utf-8")

  hash_all           = {}
  hash_mta           = {}
  hash_event_tracker = {}
  hash_tls           = {}

  # Read the config files.

  [
    [ config_all,           hash_all           ],
    [ config_mta,           hash_mta           ],
    [ config_event_tracker, hash_event_tracker ],
    [ config_tls,           hash_tls           ],
  ].each do |(dir, hash)|
    Dir["#{ dir }/*"].sort.each do |filename|
      basename = File.basename(filename)

      next if basename =~ %r{\A\.}

      content = File.read(filename, encoding: "utf-8")

      if !content.valid_encoding?
        die("file #{ filename } contains invalid UTF-8 text")
      end

      hash[basename] = content.rstrip
    end
  end

  # Remove the original "config*:" blocks (we do this with a regex instead of re-serializing the original YAML in order to
  # preserve comments in the rest of the document).

  output_yaml = input_yaml.gsub(%r{\n(config(All|Mta|EventTracker|Tls):.*((\n[ \t].*)|\n[ \t]*)*)+}, "\n")
  output_yaml.rstrip!

  # Append the new "config" keys.

  output_yaml << "\n"
  output_yaml << "\n"
  output_yaml << YAML.dump({
    "configAll"          => hash_all,
    "configMta"          => hash_mta,
    "configEventTracker" => hash_event_tracker,
    "configTls"          => hash_tls,
  }).gsub(%r{\A---\n}, "")

  # Write the output yaml.

  IO.write(output_file, output_yaml, mode: "w", perm: 0644)
end

def die(message)
  STDERR.puts("#{ $0 }: #{ message }")
  exit(1)
end

main
